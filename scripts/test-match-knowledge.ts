/**
 * Test script for match_knowledge RPC function
 * 
 * Tests the vector similarity search directly to debug discrepancies
 * between local and cloud Supabase instances.
 * 
 * Usage:
 *   npx tsx scripts/test-match-knowledge.ts
 */

import { createClient } from '@supabase/supabase-js';
import { GoogleGenAI } from '@google/genai';
import * as path from 'path';
import * as dotenv from 'dotenv';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Load environment variables
dotenv.config({ path: path.resolve(__dirname, '.env') });

// Fixed embedding from 'están regulados?'
const FIXED_EMBEDDING = [-0.012746553,-0.0021867927,0.009324672,-0.060843576,0.036630984,0.01029209,-0.004878166,0.009400147,0.01578335,0.006394796,-0.014725539,0.0171344,0.0015604391,0.010276574,0.09724154,0.0042123953,0.045617066,-0.0059659304,-0.010515647,-0.0007668572,0.0059162835,-0.0073598432,-0.013057771,0.01697246,0.007249762,-0.014221022,0.037338857,-0.0021220723,0.042824473,-0.0051716054,0.003791861,-0.01861965,-0.008707914,-0.0068297144,-0.030638434,-0.0010495235,-0.007935396,0.0072497064,-0.02340439,0.01246892,0.0022345223,0.00747937,0.002777524,0.0052341837,0.00625098,-0.0059623523,0.017133826,-0.03218625,-0.018969048,0.0086208265,0.005117529,-0.0198794,-0.006608737,-0.14488684,0.007888493,-0.010870002,-0.0055934186,-0.00029597976,0.024372347,-0.00035192783,-0.042750075,0.008005035,-0.012746288,-0.054604605,-0.0034307824,-0.011336594,-0.016407406,0.012173697,-0.0012783499,-0.010151508,0.01569763,-0.0020412167,-0.0021117777,-0.002623454,0.0205555,0.019680085,-0.0007800378,0.0027591796,-0.024006968,0.00930277,0.0025840448,0.023813857,-0.008983968,0.00025168812,0.002540977,0.00029555746,0.012289748,-0.010691742,-0.0064348658,0.0029631774,-0.032391578,-0.0098209875,-0.009800154,-0.0194619,-0.000922069,0.012749543,0.00014101015,-0.022565637,-0.017290853,-0.019273266,-0.014220953,0.000644667,-0.010463141,0.00130151,0.0092244875,0.0020698372,0.036566887,-0.0004972296,-0.0031192934,0.004904516,-0.0086006615,-0.007131121,-0.0082355365,0.015886601,0.0013474409,-0.17847371,0.009044728,0.00033074795,0.0048431945,-0.009899341,-0.014435855,0.043074805,0.0075533446,0.018879203,-0.001533092,-0.024395954,0.017074361,0.0077842367,-0.004236979,0.014774501,-0.0031801122,0.014760832,-0.008237345,0.00039359386,-0.021083476,0.04309291,-0.0041422728,-0.016684406,-0.008041207,0.016509172,0.01682457,-0.016685128,0.009615234,-0.0007883601,-0.009424516,-0.012375128,0.023322755,-0.0015265857,-0.013660831,-0.0047172555,-0.009761885,-0.0075336657,-0.028475937,0.0048105055,-0.008454487,-0.07232091,0.02090683,0.017423678,0.010696391,-0.0035948714,-0.0030666925,-0.0014321601,-0.015425282,-0.002783457,-0.008704855,0.0067037423,-0.0013435155,0.0022413994,0.010941822,-0.0149785215,-0.00784209,0.015638934,-0.007713363,-0.017298294,-0.0056179105,0.006952152,0.0007547128,0.010959971,-0.015284863,-0.0072256043,0.004276842,-0.016668845,-0.008712486,-0.0048015956,0.026583858,-0.045444362,-0.013929372,-0.015748443,-0.0047326796,-0.0062134285,-0.02391019,0.018671073,-0.007216836,-0.02228047,0.010634165,0.013155353,-0.00065721764,-0.014389205,-0.008247064,0.009264183,0.012781626,-0.005974236,-0.013237686,0.012173072,-0.0094790915,-0.017297179,-0.019043928,-0.011775751,0.015438842,0.023554616,-0.016250646,-0.010582723,-0.009045491,-0.0032045604,0.02055993,-0.00780906,0.006231407,-0.020635964,-0.0047274884,-0.029550703,-0.006229832,0.0035246266,-0.0049754702,0.014046757,-0.003473093,-0.009882813,0.038582034,-0.01015442,-0.0059618056,0.018080529,0.020796709,0.025376266,0.0127827795,0.041566737,0.012354806,-0.0021411392,-0.001683747,0.0038459275,0.025955068,0.007971216,-0.019681731,-0.008924888,0.0051344866,0.0012287964,0.0020444116,0.017605571,-0.004609392,-0.0035541966,-0.010435574,0.008510411,-0.0033217298,0.010751335,-0.022111513,0.011950245,-0.03419655,-0.013280894,-0.009425854,-0.019131951,-0.01772512,-0.03519031,0.0025562332,-0.00038357428,0.018507946,0.031186001,-0.000982433,0.0159381,0.0025771149,-0.004262727,0.00087699323,0.0020564746,0.0047898386,0.004701846,0.007392017,0.018104546,0.019994508,0.01619456,-0.110718004,0.020474805,0.0326502,-0.0134278,0.00094026333,-0.028198034,0.0034177683,0.007799588,0.0134019675,-0.016203823,-0.020646712,-0.011820655,-0.003291675,-0.005920108,0.0058997935,0.019382851,0.0041543082,-0.015401949,0.014571899,0.0074060378,0.005475143,0.014658214,-0.028339772,-0.013195367,-0.0117737325,0.017112903,0.0024517751,0.026440881,0.003821773,0.0019065522,-0.010814254,-0.010381662,-0.028594954,-0.008881575,-0.0034680301,-0.00017888329,-0.0072135176,-0.020597273,-0.02721516,-0.0041019297,-0.000029574405,-0.010807215,0.013420516,0.022923136,-0.016829666,-0.0031811825,-0.019477302,-0.0071394555,-0.022913735,-0.0020821497,-0.008248722,-0.0138203595,0.014348973,-0.0074608764,0.011830424,-0.005950544,0.0019351136,0.024439013,0.011345233,0.012680378,-0.01413542,0.00009304284,0.016686173,0.014869077,0.010015201,0.020067152,-0.011060321,0.002217841,0.007283445,0.00891639,0.0030301735,-0.03040484,0.018849546,-0.03998574,0.023090301,-0.012174014,-0.020950576,-0.010967783,-0.009025016,0.002030551,-0.028665023,-0.009359865,0.0074906517,0.008404934,0.00034856412,0.002778705,-0.0012195995,-0.0039604288,0.006745028,-0.016289178,-0.014245351,0.0017285504,-0.010239743,-0.009804343,0.009319306,-0.021860756,-0.014489356,0.026055494,0.0075485073,-0.011314824,-0.0212388,-0.015436055,0.007373893,-0.0013279376,-0.010111094,0.023090566,-0.002243641,-0.004600883,-0.0057880282,0.006449858,-0.0058927853,0.008945848,0.0143075,-0.0006514569,-0.0037656613,0.028546084,-0.00045319393,-0.011681096,-0.021526344,0.0028408559,0.011415666,-0.008532011,0.0067243245,-0.00020190378,-0.0044550896,0.003591538,-0.004950479,0.008013279,-0.008863918,0.018718798,-0.028026976,-0.0012409498,0.013100478,-0.015736632,0.013879799,0.0003346759,0.029241785,-0.00010595359,0.007906955,0.00091731804,-0.053756163,-0.003938501,0.014472371,0.01021712,-0.016840653,0.0015789473,-0.018829612,0.00081684114,0.020554883,-0.0064225984,-0.026332542,0.003267209,-0.01043661,0.005079748,-0.018969914,-0.021275114,-0.0063051474,-0.0013238256,-0.014544467,-0.027943362,0.0012278832,0.022178976,-0.013677503,0.012088974,0.020311208,0.014525773,0.030132381,0.0073375106,0.03463723,0.0022864982,0.009910318,0.02684636,-0.0134059945,0.007629577,-0.008096005,-0.00063311297,0.0075472877,-0.034786914,0.0025167947,0.011044686,-0.027540741,-0.012003565,0.0038924979,0.013505432,-0.0035503362,-0.025493959,0.015199417,-0.0072844974,-0.01142382,0.005970124,-0.0086277295,-0.022755269,0.0152504835,0.019439537,0.0017307614,0.0040960624,-0.01681592,0.019389788,-0.027414935,0.015766619,0.012385162,0.016433738,0.0059279012,0.015536325,0.026845701,0.010693408,0.0075788386,0.0016404097,-0.007419349,-0.011489835,0.008976159,-0.0055276067,-0.0033347104,-0.009735941,0.008843177,-0.009590622,-0.009258166,0.0007198197,0.008299993,-0.024969516,0.00958467,-0.024682332,0.027523357,0.004912699,0.014438908,0.0112240985,0.0027453708,0.015838338,0.003455345,0.0003651331,-0.021969218,0.0016877722,-0.0017427779,-0.008367069,-0.011749063,0.0029251669,-0.0071391887,-0.0014307349,-0.0068740663,0.021009082,0.0008466741,-0.007439819,-0.027604392,0.008683015,-0.019138684,0.0026913008,0.022180254,0.010590321,0.014101429,0.007849866,-0.003338145,-0.007638984,0.024820179,-0.008995032,-0.0012623715,0.029150352,0.013540884,-0.010068421,-0.012001694,-0.012876693,-0.009477729,-0.012326566,-0.023400282,0.006125137,0.011164956,-0.037542127,0.011352705,-0.025335675,0.019494034,-0.14383985,0.008177696,0.003973702,0.0022840984,-0.0017815498,-0.004289522,0.014259921,-0.01657279,0.017451905,-0.023638578,-0.009408456,0.018788287,-0.007358398,0.009151696,-0.013510379,-0.00029874968,0.0037931227,0.014149845,-0.013623193,-0.0026145244,0.008501899,0.025005551,0.0055162297,0.0020222845,-0.03167726,0.008750579,0.023603378,0.026800316,-0.0075362315,0.007412342,0.019956235,0.0014315943,0.012609522,0.006599503,-0.0016813196,0.004927053,-0.03058773,-0.006979764,0.00921809,0.02705526,-0.000040126983,0.010870312,-0.009154937,0.007863922,-0.02501932,-0.0040813303,0.012896007,-0.02039324,0.02555489,0.004254122,-0.019289548,-0.0003906967,-0.010629213,-0.019821329,-0.018551484,-0.019918712,0.011657124,0.0039519793,-0.00692544,-0.02134965,-0.023511523,-0.018987926,-0.011831761,0.0023672197,-0.016430728,-0.005102699,-0.027461963,-0.0048337393,0.020657754,0.013966145,0.015785603,0.014950988,0.035181187,0.007441142,-0.00007954155,0.014989299,0.02089329,-0.0074986415,0.0423278,0.005878386,-0.0055576414,0.017955873,-0.104361154,0.0116481045,0.000535542,0.015222249,0.0108571425,-0.0152983945,0.0023482882,-0.02008335,0.0055787517,-0.0015518452,0.008770925,0.004921887,-0.008836411,-0.005320534,0.00053328014,-0.02267938,-0.0038197588,0.0051071006,0.016363405,-0.020406142,-0.016867833,0.010103619,0.03217174,-0.0014063866,-0.00979222,-0.010022367,-0.0012227747,0.00812739,0.0035601233,-0.029584285,0.0033040429,-0.1327235,-0.024907276,0.002859495,0.017807083,-0.004744481,-0.0034927572,0.0006522463,-0.006730894,-0.013276145,0.0114848465,-0.0142134195,0.00013439405,-0.003106797,-0.015454725,0.0072361855,0.15331668,-0.021303076,0.008845921,0.011495686,-0.015474906,-0.000329118,0.020461371,-0.002085112,0.00056556426,0.011920098,-0.005905003,0.0029635343,0.011800877,0.029905299,0.018287593,-0.00004147458,0.019649055,0.005348699,0.011133335,0.0065548043,-0.0062339744,0.016868219,-0.020069739,0.021207986,-0.034371253,0.03019407,0.00015986798,-0.0040889196,-0.002813435,-0.028721564,-0.022951577,-0.005584902,-0.002206491,0.0021690272,0.0218848,-0.024709905,-0.05488735,0.021721482,0.016324019,0.023442501,0.0001145916,0.014371167,0.00008872572,0.02225406,0.031676915,0.05232323,-0.048913583,-0.028844928,-0.021606984,-0.010453528,-0.008694,0.0027493262,0.008168768,-0.0034936906,0.023883766,0.0015534627,0.00836523,-0.011100995,-0.017923685,-0.0023861567,-0.020597804,-0.0019511845,0.00008213406,-0.00048416833,0.027275791,0.0118975025,0.033321526,-0.0022633362,0.0010632412,0.0014996203,-0.022142073,0.03691339,-0.012979567,-0.002879411,-0.009574646,0.007923956,0.0058285436,0.008697596,-0.010939925,0.008835324,0.008938088,0.00061612687,-0.013882519,0.0066878847,0.01807612,0.011050013,0.013348575,-0.021553708,-0.016055958,-0.01020857,-0.0015791565,0.0019169505,0.013452861,0.0025764345,-0.014790414];


const TEST_QUERIES = [
  'estan regulados?',
//   'que es copy trading',
//   '12x cuenta amplificada',
//   'como retiro mi dinero',
];

async function main() {
  // Validate environment
  const supabaseUrl = process.env.SUPABASE_URL;
  const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
  const googleKey = process.env.GOOGLE_API_KEY;
  
  if (!supabaseUrl || !supabaseKey) {
    console.error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY');
    process.exit(1);
  }
  
  if (!googleKey) {
    console.error('Missing GOOGLE_API_KEY');
    process.exit(1);
  }

  console.log('='.repeat(60));
  console.log('Testing match_knowledge RPC');
  console.log('='.repeat(60));
  console.log(`Supabase URL: ${supabaseUrl}`);
  console.log('');
  
  // Initialize clients
  const supabase = createClient(supabaseUrl, supabaseKey);
  const genAI = new GoogleGenAI({ apiKey: googleKey });
  
  // First, check if data exists
  const { count, error: countError } = await supabase
    .from('knowledge_base')
    .select('*', { count: 'exact', head: true });
  
  if (countError) {
    console.error('Error checking data:', countError.message);
    process.exit(1);
  }
  
  console.log(`Knowledge base entries: ${count}`);
  console.log('');
  
  // Test each query
  for (const query of TEST_QUERIES) {
    console.log('-'.repeat(60));
    console.log(`Query: "${query}"`);
    console.log('-'.repeat(60));
    
    // Generate embedding
    const result = await genAI.models.embedContent({
      model: 'gemini-embedding-001',
      contents: query,
      config: { outputDimensionality: 768, taskType: 'RETRIEVAL_QUERY' }
    });
    
    // const embedding = result.embeddings?.[0]?.values;
    const embedding = FIXED_EMBEDDING;
    
    if (!embedding) {
      console.error('  ❌ Failed to generate embedding');
      continue;
    }
    
    console.log(`  Embedding length: ${embedding.length}`);
    console.log(`  First 3 values: [${embedding.slice(0, 3).map(v => v.toFixed(6)).join(', ')}]`);
    
    // Format embedding as pgvector expects it - as a string '[x,y,z,...]'
    const embeddingString = `[${embedding.join(',')}]`;
    console.log(`  Embedding string length: ${embeddingString.length} chars`);
    
    // Call match_knowledge RPC
    console.log('  Calling RPC...');
    const { data, error } = await supabase.rpc('match_knowledge', {
      schema_name: 'public',
      query_embedding: embeddingString,
      match_count: 5,
    });
    
    console.log('  Raw response:', { dataLength: data?.length || 0, error: error ? error.message : null });
    
    if (error) {
      console.error(`  ❌ RPC Error: ${error.message}`);
      console.error(`     Code: ${error.code}`);
      console.error(`     Details: ${JSON.stringify(error)}`);
      continue;
    }
    
    if (!data || data.length === 0) {
      console.log('  ⚠️  No results returned');
      continue;
    }
    
    console.log(`  ✅ Results: ${data.length}`);
    console.log('');
    
    data.forEach((row: any, i: number) => {
      console.log(`  ${i + 1}. [${(row.similarity * 100).toFixed(1)}%] ${row.title.slice(0, 60)}`);
    });
    
    console.log('');
  }
  
  // Also test direct table query
  console.log('-'.repeat(60));
  console.log('Direct table query test:');
  console.log('-'.repeat(60));
  const { data: directData, error: directError } = await supabase
    .from('knowledge_base')
    .select('title, category')
    .eq('is_active', true)
    .limit(3);
  
  if (directError) {
    console.log('Direct query error:', directError.message);
  } else {
    console.log('Direct query results:', directData?.length);
    directData?.forEach((r: any) => console.log(`  - ${r.title.slice(0, 50)}`));
  }
  
  console.log('='.repeat(60));
  console.log('Test complete!');
}

main().catch(console.error);
